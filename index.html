<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>商品検索マップ</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
      position: relative;
      overflow: hidden;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #category-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 300px;
      z-index: 1001;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 10px;
      box-sizing: border-box;
      border-bottom: 1px solid #ccc;
    }

    #category-select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      max-height: 200px;
      overflow-y: auto;
    }

    #sidebar {
      position: absolute;
      top: 60px;
      left: 0;
      width: 300px;
      height: calc(100% - 60px);
      background-color: rgba(255, 255, 255, 0.9);
      overflow-y: auto;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
      z-index: 1000;
      display: none; /* 初期状態非表示 */
    }

    #detail-panel {
      position: absolute;
      top: 0;
      left: 300px;
      width: 300px;
      background-color: rgba(255, 255, 255, 0.9);
      border-left: 1px solid #ccc;
      box-sizing: border-box;
      z-index: 1000;
      transition: height 0.3s ease;
    }

    #detail-panel.collapsed {
      display: none;
    }

    #detail-panel.open,
    #detail-panel.expanded {
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 769px) {
      #detail-panel.expanded {
        height: 100%;
      }
    }

    #detail-panel.open {
      height: 50%;
    }

    #detail-panel.expanded {
      height: 100%;
    }

    .handle-bar, .close-button {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1001;
    }

    .handle-bar {
      width: 50px;
      height: 5px;
      background: #aaa;
      border-radius: 2px;
      margin: 10px auto;
      cursor: grab;
    }

    .close-button {
      text-align: right;
      border-bottom: 1px solid #ccc;
      padding: 10px;
    }

    #detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .store-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .store-item:hover {
      background-color: #f0f0f0;
    }

    .store-item strong {
      color: #007bff;
    }

    #detail-content h3,
    #detail-content h4 {
      margin-top: 0;
    }

    .result-item {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    @media (max-width: 768px) {
      #category-container {
        width: 100%;
        left: 0;
      }

      #sidebar {
        top: auto;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        max-height: 50%;
        border-right: none;
        border-top: 1px solid #ccc;
        display: none;
        transition: height 0.3s ease;
      }

      #sidebar.open {
        display: block;
        height: 50%;
      }

      #detail-panel {
        top: auto;
        bottom: 0;
        left: 0;
        width: 100%;
        border-left: none;
        border-top: 1px solid #ccc;
        transition: height 0.3s ease;
      }

      #detail-content {
        padding-top: 10px; 
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="category-container">
    <select id="category-select"></select>
  </div>
  <div id="sidebar">
    <div id="store-list"></div>
  </div>
  <div id="detail-panel" class="collapsed">
    <div class="handle-bar"></div>
    <div class="close-button">
      <button id="close-detail">&times;</button>
    </div>
    <div id="detail-content"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <!-- Firebase 初期化 -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIMBWXXx5fd3wJGUUT8c1ban56czRMITQ",
      authDomain: "mapshopping-80415.firebaseapp.com",
      projectId: "mapshopping-80415",
      storageBucket: "mapshopping-80415.appspot.com",
      messagingSenderId: "298544341559",
      appId: "1:298544341559:web:9f019bdbae1d7e5837d5b2",
      measurementId: "G-6B5HP3JHGB"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <script>
    const db = firebase.firestore();

    const map = L.map('map').setView([35.0116, 135.7681], 13); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const defaultIcon = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      shadowSize: [41, 41]
    });

    const selectedIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      shadowSize: [41, 41]
    });

    const markersLayer = L.layerGroup().addTo(map);
    let currentSelectedMarker = null;

    window.addEventListener('DOMContentLoaded', loadCategories);

    async function loadCategories() {
      const categorySelect = document.getElementById('category-select');
      const categories = [
        { id: 'outerwear', name: 'アウターウェア' },
        { id: 'tops', name: 'トップス' },
        { id: 'bottoms', name: 'ボトムス' },
        { id: 'jackets', name: 'ジャケット' },
        { id: 'shirts', name: 'シャツ' },
        { id: 'pants', name: 'パンツ' },
        { id: 'sweatshirts', name: 'スウェットシャツ' },
        { id: 't-shirts', name: 'Tシャツ' },
        { id: 'denim', name: 'デニム' },
        { id: 'accessories', name: 'アクセサリー' },
      ];

      categories.forEach(category => {
        const categoryOption = document.createElement('option');
        categoryOption.value = category.id;
        categoryOption.textContent = category.name;
        categorySelect.appendChild(categoryOption);
      });

      if (categorySelect.options.length > 0) {
        categorySelect.selectedIndex = 0;
        searchItems(); 
      }
    }

    document.getElementById('category-select').addEventListener('change', searchItems);

    const sidebar = document.getElementById('sidebar');
    const detailPanel = document.getElementById("detail-panel");

    async function searchItems() {
      const categorySelect = document.getElementById('category-select');
      const selectedCategory = categorySelect.value;

      markersLayer.clearLayers();
      document.getElementById("store-list").innerHTML = "";
      document.getElementById("detail-content").innerHTML = "";

      if (window.innerWidth <= 768) {
        sidebar.classList.remove('open');
      }

      if (!selectedCategory) {
        alert("カテゴリを選択してください。");
        return;
      }

      let query = db.collectionGroup('items').where('category_id', '==', selectedCategory);
      const querySnapshot = await query.get();

      if (querySnapshot.empty) {
        alert("該当する商品が見つかりませんでした。");
        return;
      }

      sidebar.style.display = "block";
      if (window.innerWidth <= 768) {
        sidebar.classList.add('open');
      }

      const storeItemsMap = {};
      querySnapshot.forEach(doc => {
        const item = doc.data();
        const storeId = item.store_id;
        if (!storeItemsMap[storeId]) {
          storeItemsMap[storeId] = [];
        }
        storeItemsMap[storeId].push(item);
      });

      if (Object.keys(storeItemsMap).length === 0) {
        alert("該当する商品が見つかりませんでした。");
        return;
      }

      for (const storeId in storeItemsMap) {
        const items = storeItemsMap[storeId];
        const storeRef = db.collection("stores").doc(storeId);
        const storeDoc = await storeRef.get();

        if (storeDoc.exists) {
          const store = storeDoc.data();

          const marker = L.marker([store.latitude, store.longitude], { icon: defaultIcon }).addTo(markersLayer);
          marker.storeId = storeId;

          marker.on('click', () => {
            showDetailPanel(store, items);
            if (currentSelectedMarker && currentSelectedMarker !== marker) {
              currentSelectedMarker.setIcon(defaultIcon);
            }
            marker.setIcon(selectedIcon);
            currentSelectedMarker = marker;
          });

          const storeList = document.getElementById("store-list");
          const storeItem = document.createElement("div");
          storeItem.className = "store-item";
          storeItem.innerHTML = `
            <strong>${store.name}</strong><br>
            住所: ${store.address}
          `;
          storeItem.onclick = () => {
            map.setView([store.latitude, store.longitude], 16);
            marker.openPopup();
            showDetailPanel(store, items);

            if (currentSelectedMarker && currentSelectedMarker !== marker) {
              currentSelectedMarker.setIcon(defaultIcon);
            }
            marker.setIcon(selectedIcon);
            currentSelectedMarker = marker;
          };
          storeList.appendChild(storeItem);
        }
      }
    }

    function showDetailPanel(store, items) {
      const detailContent = document.getElementById("detail-content");
      detailContent.innerHTML = '';

      // 複数商品がある場合は全て表示
      // 住所は表示しない、商品名は商品ごとに1回だけ表示
      // itemsは複数商品分が入っている可能性あり
      detailContent.innerHTML = `<h4>商品情報</h4>`;
      items.forEach(item => {
        detailContent.innerHTML += `
          <div class="result-item">
            <h3>${item.product_name}</h3>
            <img src="${item.image_url}" alt="${item.product_name}" style="max-width:100px;height:auto;display:block;"><br>
            価格: ¥${item.price}<br>
            ${item.sizes && item.sizes.length > 0 ? "サイズ: " + item.sizes.join(", ") : ""}
          </div>
        `;
      });

      detailPanel.classList.remove('collapsed','open','expanded');
      if (window.innerWidth <= 768) {
        detailPanel.classList.add('open');
        sidebar.classList.remove('open');
      } else {
        detailPanel.classList.add('expanded');
      }
    }

    document.getElementById('close-detail').addEventListener('click', () => {
      detailPanel.classList.remove('open','expanded');
      detailPanel.classList.add('collapsed');

      if (window.innerWidth <= 768) {
        sidebar.classList.add('open');
      }

      if (currentSelectedMarker) {
        currentSelectedMarker.setIcon(defaultIcon);
        currentSelectedMarker = null;
      }
    });

    let startY;
    let startHeight;
    let isDragging = false;
    const handleBar = document.querySelector('#detail-panel .handle-bar');

    handleBar.addEventListener('touchstart', (e) => {
      isDragging = true;
      startY = e.touches[0].clientY;
      startHeight = detailPanel.offsetHeight;
    });

    handleBar.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const deltaY = startY - e.touches[0].clientY;
      let newHeight = startHeight + deltaY;

      const screenHeight = window.innerHeight;
      newHeight = Math.max(0, Math.min(screenHeight, newHeight));

      detailPanel.style.height = newHeight + 'px';
    });

    handleBar.addEventListener('touchend', () => {
      isDragging = false;
      const currentHeight = detailPanel.offsetHeight;
      const screenHeight = window.innerHeight;
      const ratio = currentHeight / screenHeight;

      detailPanel.classList.remove('open','expanded','collapsed');
      if (ratio >= 0.7) {
        detailPanel.classList.add('expanded');
        detailPanel.style.height = '100%';
      } else if (ratio >= 0.3) {
        detailPanel.classList.add('open');
        detailPanel.style.height = '50%';
      } else {
        detailPanel.classList.add('collapsed');
        detailPanel.style.height = '0%';
      }
    });
  </script>
</body>
</html>
